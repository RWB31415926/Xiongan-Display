<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>雄安新区交通推演平台</title>

<!-- ============ 统一主题：一个地方改全站色 ============ -->
<style>
    :root{
      --bg:        #0b1d2c;  /* 页面背景 */
      --panel:     #0e2538;  /* 面板背景 */
      --text:      #e7f6ff;  /* 主文字 */
      --muted:     #7bdcff;  /* 次级文字 */
      --accent1:   #f9d65c;  /* 图表配色 1 */
      --accent2:   #33d2c2;  /* 图表配色 2 */
      --accent3:   #20c997;  /* 图表配色 3 */
      --accent4:   #6f42c1;  /* 图表配色 4 */
      --accent5:   #d63384;  /* 图表配色 5 */
      --radius:    12px;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",
                   Arial,"PingFang SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;}
    .main{display:grid; grid-template-columns: 0.8fr 1.4fr 0.8fr; gap:12px; padding:10px; min-height:100vh; box-sizing:border-box;}
    .panel{background:var(--panel); border-radius:var(--radius); box-shadow:0 10px 24px rgba(0,0,0,.25); overflow:hidden;}
    .title{padding:10px 12px; color:var(--muted); font-size:14px; border-bottom:1px solid rgba(255,255,255,.06);}
    .content{padding:12px;}

    .left-col{display:grid; grid-template-rows: auto auto 360px; gap:12px;}
    .mid-col{display:grid; grid-template-rows: auto 360px; gap:12px;}
    .right-col{display:grid; grid-template-rows: auto auto 360px; gap:12px;}

    /* 图片挂载容器（用于 JSON/HTML 插图） */
    .img-slot{position:relative; display:flex; align-items:center; justify-content:center; width:100%; height:100%;}
    .img-slot img{max-width:100%; max-height:100%; object-fit:contain;}
    /* iframe 若后续需要，可在同页或外链，这里用图片替代，避免外部依赖带来的色差 */
  </style>
<!-- 仅保留 ECharts 5（统一版本，避免冲突） -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <!-- Plotly（用于渲染 JSON 图表） -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<!-- ============ JSON 数据都内嵌到页面中（单文件） ============ -->
<!-- 1) 饼图数据：直接改 labels / counts 即可 -->

<!-- 2) 图片批量插入：containerId 定位到某个容器；absolute 可选像素级控制 -->
<script id="images-json" type="application/json">
  [
    {
      "containerId": "imgSlotA",
      "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc5MDAnIGhlaWdodD0nNDIwJz4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICA8c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjMjAzNDQ3Jy8+CiAgICAgIDxzdG9wIG9mZnNldD0nMTAwJScgc3RvcC1jb2xvcj0nIzE1MjYzNScvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9JzEwMCUnIGhlaWdodD0nMTAwJScgZmlsbD0ndXJsKCNnKScvPgogIDxnIGZpbGw9J3doaXRlJyBmb250LWZhbWlseT0nQXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWYnPgogICAgPHRleHQgeD0nNTAlJyB5PSc1MCUnIGZvbnQtc2l6ZT0nMzAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnPuWIhuWMuuWHuuihjOaViOeOh+aOkuihjO+8iOWNoOS9jeWbvu+8iTwvdGV4dD4KICA8L2c+Cjwvc3ZnPg==",
      "alt": "分区出行效率排行",
      "absolute": null
    },
    {
      "containerId": "imgSlotB",
      "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc5MDAnIGhlaWdodD0nNDIwJz4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICA8c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjMjAzNDQ3Jy8+CiAgICAgIDxzdG9wIG9mZnNldD0nMTAwJScgc3RvcC1jb2xvcj0nIzE1MjYzNScvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9JzEwMCUnIGhlaWdodD0nMTAwJScgZmlsbD0ndXJsKCNnKScvPgogIDxnIGZpbGw9J3doaXRlJyBmb250LWZhbWlseT0nQXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWYnPgogICAgPHRleHQgeD0nNTAlJyB5PSc1MCUnIGZvbnQtc2l6ZT0nMzAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnPuWPkeeUn+mHj+WIhuW4g++8iOWNoOS9jeWbvu+8iTwvdGV4dD4KICA8L2c+Cjwvc3ZnPg==",
      "alt": "发生量分布",
      "absolute": {"top":"8px","left":"10px","width":"92%","height":"auto"}
    },
    {
      "containerId": "imgSlotC",
      "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc5MDAnIGhlaWdodD0nNDIwJz4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0nZycgeDE9JzAnIHkxPScwJyB4Mj0nMScgeTI9JzEnPgogICAgICA8c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjMjAzNDQ3Jy8+CiAgICAgIDxzdG9wIG9mZnNldD0nMTAwJScgc3RvcC1jb2xvcj0nIzE1MjYzNScvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9JzEwMCUnIGhlaWdodD0nMTAwJScgZmlsbD0ndXJsKCNnKScvPgogIDxnIGZpbGw9J3doaXRlJyBmb250LWZhbWlseT0nQXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWYnPgogICAgPHRleHQgeD0nNTAlJyB5PSc1MCUnIGZvbnQtc2l6ZT0nMzAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnPua1gemHjy3pgJ/luqbnu5/orqHvvIjljaDkvY3lm77vvIk8L3RleHQ+CiAgPC9nPgo8L3N2Zz4=",
      "alt": "流量-速度统计",
      "absolute": null
    }
  ]
  </script>
<style>

.header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: var(--panel);
  display: flex;
  align-items: center;
  justify-content: center; /* center the title block */
  z-index: 1000;
}

/* Center title */
.header-center {
  pointer-events: none; /* so clicks pass through if needed */
}
.header-title {
  font-size: 24px;
  font-weight: bold;
  color: var(--text);
  text-align: center;
}/* 场景下拉框统一深色风格 */
#scenarioSel {
  background-color: var(--panel);   /* 用和面板一致的深色 */
  color: var(--text);               /* 文字颜色与主题文字一致 */
  font-weight: bold;                /* 加粗文字 */
  border: 1px solid rgba(255,255,255,0.3); /* 半透明边框 */
  border-radius: 4px;               /* 圆角 */
  padding: 4px 8px;                 /* 内边距 */
  outline: none;                    /* 选中时不显示默认边框 */
}

/* 下拉选项保持深色风格 */
#scenarioSel option {
  background-color: var(--panel);
  color: var(--text);
  font-weight: bold;
}


/* Left & Right utility areas (time / buttons) */
.header-left, .header-right {
  position: absolute;
  top: 0;
  height: 60px;
  display: flex;
  align-items: center;
  color: var(--text);
  font-size: 14px;
}
.header-left { left: 12px; }
.header-right { right: 12px; }

/* Push content below the fixed header */
.main {
  padding-top: 70px;
}
</style>


</head>
<body>
<!--  标题 -->
  <div class="header">
    <div class="header-left fl" id="time"></div>
    <div class="header-center fl">
      <div class="header-title">
        雄安新区交通推演平台
      </div>
      <div class="header-img"></div>
    </div>
    <div class="header-right fl">
        <label style="display:inline-flex;gap:6px;align-items:center;color:var(--text);">
            <span>场景：</span>
            <select id="scenarioSel">
                <option value="short">短期</option>
                <option value="mid">中期</option>
                <option value="long">远期</option>
            </select>
        </label>
    </div>
    <div class="header-bottom fl"></div>
  </div>
  <!-- 下面是主体内容 -->
<div class="main">
<!-- 左列 -->
<div class="left-col">
<section class="panel">
<div class="title">基本信息（短/中/远期切换）</div>
<div class="content">
<label style="display:inline-flex;gap:8px;align-items:center;">

<ul id="statsList" style="margin-top:10px; line-height:1.9;"></ul>
</div>
</section>

<section class="panel">
<div class="title">交通运行状况（随场景切换）</div>
<div class="content">
<ul id="opsList" style="line-height:1.9;"></ul>
</div>
</section>
<section class="panel">
<div class="title">流量情况占比（JSON 驱动）</div>
<div id="chart3" style="height:100%;"></div>
</section>
</div>

<!-- 中列 -->
<div class="mid-col">
<section class="panel">
  <div class="title">地图/底图位</div>
  <div class="img-slot" id="imgSlotMap">
    <iframe src="static/html/kepler.gl.html"
            style="width:100%; height:100%; border:none;"
            title="交通地图"></iframe>
  </div>
</section>

<section class="panel">
  <div class="title">流量与速度（日变化）</div>
  <div class="img-slot">
    <!-- Plotly 将把 JSON 渲染到这个容器里 -->
    <div id="dayPlot" style="width:100%;height:100%;"></div>
  </div>
</section>

</div>
<!-- 右列 -->
<div class="right-col">
<section class="panel">
<div class="title">分区出行效率排行（HTML 插图）</div>
<div class="img-slot" id="imgSlotA"></div>
</section>
<section class="panel">
<div class="title">发生量分布（JSON 插图）</div>
<div class="img-slot" id="imgSlotB"></div>
</section>

<section class="panel">
<div class="title">公交在网数据</div>
<div class="img-slot" id="imgSlotC"></div>
</section>

</div>
</div>
<!-- ============ 业务脚本：精简 + 注释齐全 ============ -->
<script>
(function() {
  function init(){
    var dom = document.getElementById('chart3');
    if (!dom){ console.error('#chart3 容器缺失'); return; }
    if (!window.echarts){ console.error('ECharts 未加载'); return; }
    var chart3 = echarts.init(dom);
    fetch('static/js/flow_bins.json').then(r=>r.json()).then(function(data){
      const labelsFull  = data.labels || [];
      const labelsShort = data.labels_short || labelsFull; // 用短标签展示
      const counts = data.counts || [];
      const seriesData = labelsShort.map((name,i)=>({
        name, value: counts[i]||0, full: labelsFull[i] || name
      }));

      const PANEL = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim() || '#0b1d2c';
      const TEXT  = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#ffffff';

      chart3.setOption({
        backgroundColor: PANEL,
        tooltip: {
          trigger:'item',
          formatter: p => `${p.data.full}<br/>数量：${p.value}<br/>占比：${p.percent.toFixed(1)}%` // tooltip 显示全称
        },
        legend: {
          bottom: 6, type: 'scroll',   // 防止图例换行挤占空间
          textStyle:{ color:TEXT }, itemWidth:12, itemHeight:12,
          data: labelsShort
        },
        series: [{
          type:'pie',
          radius:['43%','66%'],        // 略缩半径
          center:['44%','50%'],        // 向左/下微移，给右侧标签留空间
          color: ['#f9d65c','#33d2c2','#20c997','#6f42c1','#d63384'],
          itemStyle:{ borderColor: PANEL, borderWidth: 2 },
          label: {
            show:true,
            color:TEXT,
            formatter: p => `${p.name}: ${(Number(p.percent)||0).toFixed(1)}%`,
            alignTo:'edge',
            margin:8,
            edgeDistance:'6%',
            // 给标签一个最大宽度，避免超出容器
            width: 120,
            overflow: 'break'          // 宽度不够时自动换行
          },
          labelLine:{ show:true, length:12, length2:10, lineStyle:{ color:TEXT } },
          labelLayout: { moveOverlap: 'shiftY', hideOverlap: true }, // 避免重叠
          data: seriesData
        }]
      });

      window.addEventListener('resize', ()=>chart3.resize());
    }).catch(err=>console.error('flow_bins.json 加载失败', err));
  }
  if (document.readyState === 'complete') init();
  else window.addEventListener('load', init);
})();
</script>


<script>
(function(){
  function pad(n){ return n<10 ? '0'+n : ''+n; }
  function updateClock(){
    var el = document.getElementById('time');
    if (!el) return;
    var now = new Date();
    el.textContent =
      now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + ' ' +
      pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds());
  }
  updateClock();
  setInterval(updateClock, 1000);
})();
</script>

<script>
(function () {
  // 获取主题变量，保持与页面风格一致
  const rootStyle = getComputedStyle(document.documentElement);
  const PANEL_BG = rootStyle.getPropertyValue('--panel').trim() || '#0e2538';
  const TEXT_CLR = rootStyle.getPropertyValue('--text').trim()  || '#e7f6ff';

  // Flask 下用 url_for 来引用静态 JSON（放在 /static/js）
  const DATA_URL = "static/js/day_chart.json";

  function renderDayPlot() {
    const mount = document.getElementById('dayPlot');
    if (!mount) return;

    fetch(DATA_URL)
      .then(r => r.json())
      .then(fig => {
        // —— 风格对齐：确保文字颜色与页面一致，背景透明保持面板底色透出 ——
        fig.layout = Object.assign({}, fig.layout, {
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor:  'rgba(0,0,0,0)',
          font: Object.assign({ color: TEXT_CLR }, fig.layout?.font || {}),
        {#  legend: Object.assign({#}
        {#    orientation: 'h',#}
        {#    yanchor: 'bottom', y: 1.02,#}
        {#    xanchor: 'center', x: 0.5#}
        {#  }, fig.layout?.legend || {})#}
        });

        // 如需在这里“临时”调整 y 轴范围，也很方便（示例注释）：
        // fig.layout.yaxis  = Object.assign({}, fig.layout.yaxis,  { range: [0, 12000] }); // Flow
        // fig.layout.yaxis2 = Object.assign({}, fig.layout.yaxis2, { range: [0,   120] }); // Speed

        Plotly.newPlot(mount, fig.data, fig.layout, {
          displayModeBar: true,
          displaylogo: false,
          responsive: true,
          scrollZoom: true
        });
      })
      .catch(err => {
        console.error('day_chart.json 加载失败：', err);
        mount.innerHTML = '<div style="color:'+TEXT_CLR+';padding:12px;">无法加载 /static/js/day_chart.json</div>';
      });
  }

  if (document.readyState === 'complete') renderDayPlot();
  else window.addEventListener('load', renderDayPlot);
})();
</script>

<script>
(function(){
  const mount = document.getElementById('imgSlotC'); // 右列“公交车流量统计”
  if (!mount || !window.echarts) return;

  const chart = echarts.init(mount);

  // 读取主题变量，统一配色
  const css = getComputedStyle(document.documentElement);
  const PANEL = css.getPropertyValue('--panel').trim() || '#0e2538';
  const TEXT  = css.getPropertyValue('--text').trim()  || '#e7f6ff';

  fetch("static/js/flow_speed_scatter.json")
    .then(r => r.json())
    .then(opt => {
      // 背景、坐标轴文字颜色与主题统一
      opt.backgroundColor = PANEL;

      // 合并/追加坐标轴样式（避免被覆盖）
      opt.xAxis = Object.assign({
        axisLine:  { lineStyle: { color: TEXT } },
        axisLabel: { color: TEXT, margin: 10 },
        nameTextStyle: { color: TEXT }
      }, opt.xAxis || {});

      opt.yAxis = Object.assign({
        axisLine:  { lineStyle: { color: TEXT } },
        axisLabel: { color: TEXT, margin: 8 },
        nameTextStyle: { color: TEXT }
      }, opt.yAxis || {});

      // tooltip 在前端定义 formatter（JSON 里不能放函数）
      opt.tooltip = {
        trigger: 'item',
        formatter: function (p) {
          const d = p.data;               // dataset 的一行记录
          // d 形如 {id, flow, speed}
          return [
            '路口：' + d.id,
            '流量：' + d.flow + ' veh/h',
            '速度：' + Number(d.speed).toFixed(1) + ' km/h'
          ].join('<br/>');
        },
        backgroundColor: 'rgba(14,37,56,0.95)',
        borderColor: 'rgba(255,255,255,0.10)',
        textStyle: { color: TEXT }
      };

      // 再保证网格边距与“标签参与布局”生效，避免裁切
      opt.grid = Object.assign({left:56,right:36,top:24,bottom:44,containLabel:true}, opt.grid || {});

      chart.setOption(opt);
      window.addEventListener('resize', () => chart.resize());
    })
    .catch(err => {
      console.error('flow_speed_scatter.json 加载失败：', err);
      mount.innerHTML = '<div style="color:'+TEXT+';padding:12px;">无法加载 /static/js/flow_speed_scatter.json</div>';
    });
})();
</script>



</body>
</html>
